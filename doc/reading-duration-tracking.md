# 精确阅读时长跟踪功能实现设计

## 1. 功能概述

### 1.1 目标

实现精确阅读时长跟踪功能，为XMnote API提供详细的阅读时长数据，包括：

- **精确阅读时长记录** (`preciseReadingDurations`)：记录具体的阅读开始时间、结束时间和阅读位置
- **模糊阅读时长记录** (`fuzzyReadingDurations`)：记录日期和总阅读时长

### 1.2 功能价值

- 为用户提供详细的阅读统计数据
- 支持XMnote生成阅读习惯分析和进度跟踪
- 帮助用户了解自己的阅读模式和效率

## 2. 技术挑战与限制

### 2.1 Zotero限制

- **核心问题**：Zotero本身没有内置阅读时长跟踪功能
- **PDF阅读器**：Zotero使用内置PDF阅读器，但不提供阅读时长API
- **数据持久化**：需要找到合适的存储方案来保存跟踪数据

### 2.2 技术挑战

- **阅读检测**：如何准确检测用户是否在阅读（而非仅仅打开了文档）
- **多文档并发**：用户可能同时打开多个PDF文档
- **数据同步**：如何在不同设备间同步阅读数据
- **性能影响**：确保跟踪功能不影响Zotero的正常使用

## 3. 实现架构设计

### 3.1 核心组件

#### 3.1.1 阅读会话管理器 (ReadingSessionManager)

- **职责**：管理阅读会话的生命周期
- **功能**：
    - 检测PDF文档的打开/关闭事件
    - 创建、维护和结束阅读会话
    - 处理用户活动检测（鼠标移动、键盘输入、滚动等）
    - 管理多文档并发阅读场景

#### 3.1.2 阅读数据收集器 (ReadingDataCollector)

- **职责**：收集阅读过程中的详细数据
- **功能**：
    - 记录阅读开始/结束时间
    - 跟踪阅读位置变化（页码、滚动位置）
    - 检测用户活动状态（活跃/非活跃）
    - 处理页面切换和位置跳转

#### 3.1.3 阅读数据存储器 (ReadingDataStorage)

- **职责**：管理阅读数据的持久化存储
- **功能**：
    - 将阅读会话数据存储到Zotero数据库
    - 提供数据查询和检索接口
    - 处理数据清理和归档
    - 支持数据导出和备份

#### 3.1.4 阅读数据分析器 (ReadingDataAnalyzer)

- **职责**：处理和分析原始阅读数据
- **功能**：
    - 合并短时间间隔的阅读会话
    - 过滤无效或极短的阅读记录
    - 生成精确和模糊阅读时长数据
    - 计算阅读统计信息

### 3.2 数据流程

```
用户打开PDF → 阅读会话管理器检测 → 创建阅读会话
       ↓
用户阅读过程 → 数据收集器记录 → 实时更新会话数据
       ↓
用户关闭PDF → 会话管理器结束会话 → 数据分析器处理
       ↓
处理后的数据 → 存储器持久化 → 导出时包含在XMnote数据中
```

## 4. 数据存储方案

### 4.1 存储策略

- **主存储**：使用Zotero的附加字段 (Extra Field) 存储JSON格式的阅读数据
- **备选方案**：使用Zotero的注释系统存储特殊格式的阅读记录
- **本地缓存**：使用插件的本地存储缓存活跃会话数据

### 4.2 数据结构

#### 4.2.1 阅读会话记录

```json
{
  "readingSessions": [
    {
      "id": "session_uuid",
      "itemKey": "zotero_item_key",
      "startTime": 1736428889486,
      "endTime": 1736429089486,
      "duration": 200000,
      "startPosition": 10.5,
      "endPosition": 15.3,
      "pageChanges": [
        { "time": 1736428900000, "position": 11.0 },
        { "time": 1736428950000, "position": 13.2 }
      ],
      "activeTime": 180000,
      "inactiveTime": 20000
    }
  ]
}
```

## 5. 用户界面设计

### 5.1 设置面板

- **启用/禁用**：阅读跟踪功能开关
- **跟踪精度**：设置活动检测的敏感度
- **数据清理**：设置自动清理旧数据的策略
- **隐私设置**：控制数据收集的范围

### 5.2 统计展示

- **阅读仪表板**：显示今日/本周/本月阅读时长
- **文档统计**：每个文档的阅读时长和进度
- **阅读历史**：详细的阅读会话历史记录

### 5.3 状态指示器

- **阅读状态**：在PDF阅读器中显示当前阅读状态
- **时长显示**：实时显示当前阅读会话时长
- **同步状态**：显示数据同步和存储状态

## 6. 实现阶段

### 6.1 第一阶段：基础框架

- 实现阅读会话管理器的核心功能
- 建立PDF文档打开/关闭事件监听
- 创建基础数据存储结构
- 实现简单的时长记录功能

### 6.2 第二阶段：精确跟踪

- 添加用户活动检测机制
- 实现位置跟踪功能
- 优化数据收集精度
- 处理多文档并发场景

### 6.3 第三阶段：数据分析

- 实现智能会话合并算法
- 添加数据清理和过滤功能
- 生成符合XMnote API的数据格式
- 优化性能和内存使用

### 6.4 第四阶段：用户界面

- 开发设置和配置界面
- 实现阅读统计展示
- 添加数据导出和管理功能
- 完善用户体验

## 7. 数据质量保证

### 7.1 准确性策略

- **活动检测**：通过鼠标、键盘、滚动事件检测真实阅读活动
- **时间校正**：处理系统时间变更和时区问题
- **异常处理**：识别和过滤异常的阅读记录

### 7.2 数据验证

- **最小阅读时长**：过滤少于配置阈值的会话
- **最大连续时长**：分割异常长的连续阅读记录
- **位置合理性**：验证阅读位置变化的合理性

## 8. 隐私和安全

### 8.1 数据隐私

- **本地存储**：所有阅读数据存储在用户本地
- **用户控制**：提供完整的数据删除和清理选项
- **透明度**：清晰说明收集的数据类型和用途

### 8.2 数据安全

- **加密存储**：敏感阅读数据可选加密存储
- **访问控制**：确保只有授权的插件功能可以访问数据
- **数据备份**：提供数据备份和恢复机制

## 9. 性能考虑

### 9.1 性能优化

- **异步处理**：使用异步机制处理数据收集和存储
- **批量操作**：批量处理数据写入和更新操作
- **内存管理**：及时清理不需要的会话数据
- **事件节流**：对高频事件进行节流处理

### 9.2 资源使用

- **CPU使用**：最小化对Zotero主进程的影响
- **内存占用**：控制活跃会话数据的内存使用
- **存储空间**：提供数据清理和压缩选项

## 10. 测试策略

### 10.1 功能测试

- **基础功能**：测试会话创建、记录、结束的完整流程
- **边界条件**：测试极短和极长的阅读会话
- **并发测试**：测试多文档同时阅读的场景
- **异常处理**：测试网络中断、系统崩溃等异常情况

### 10.2 性能测试

- **负载测试**：测试长时间运行的稳定性
- **内存泄漏**：检查长期使用是否存在内存泄漏
- **响应时间**：确保功能不影响Zotero的响应速度

## 11. 实施建议

### 11.1 开发优先级

1. **高优先级**：基础的时长记录功能，确保核心功能可用
2. **中优先级**：精确的活动检测和位置跟踪
3. **低优先级**：高级统计功能和可视化界面

### 11.2 风险管控

- **渐进式开发**：分阶段实现，每个阶段都能提供基础价值
- **可配置性**：提供丰富的配置选项，适应不同用户需求
- **降级方案**：在某些功能不可用时提供基础的记录能力

## 12. 未来扩展

### 12.1 高级功能

- **AI阅读分析**：使用机器学习分析阅读模式
- **跨设备同步**：支持多设备间的阅读数据同步
- **社交功能**：与其他用户分享阅读进度和统计

### 12.2 集成扩展

- **第三方工具**：与其他阅读工具和时间跟踪应用集成
- **云端备份**：支持将阅读数据备份到云端服务
- **数据分析**：提供更深入的阅读行为分析报告
